<muestra-codigo>
 <div>
  <div><span
     style="color: #800000;">&lt;?php</span></div><br>
  <div><span
     style="color: #0000ff;">namespace</span><span
     style="color: #000000;"> </span><span
     style="color: #267f99;">Srv</span><span
     style="color: #000000;">;</span></div><br>
  <div><span
     style="color: #0000ff;">use</span><span
     style="color: #000000;"> </span><span
     style="color: #267f99;">\SplObjectStorage</span><span
     style="color: #000000;">;</span></div>
  <div><span
     style="color: #0000ff;">use</span></div>
  <div><span
     style="color: #000000;">&nbsp;Ratchet\</span><span
     style="color: #267f99;">MessageComponentInterface</span><span
     style="color: #000000;">;</span></div>
  <div><span
     style="color: #0000ff;">use</span><span
     style="color: #000000;"> Ratchet\</span><span
     style="color: #267f99;">ConnectionInterface</span><span
     style="color: #000000;">;</span></div><br>
  <div><span
     style="color: #0000ff;">const</span><span
     style="color: #000000;"> ID = </span><span
     style="color: #a31515;">"id"</span><span
     style="color: #000000;">;</span></div>
  <div><span
     style="color: #0000ff;">const</span><span
     style="color: #000000;"> CASTIGADO = </span><span
     style="color: #a31515;">"castigado"</span><span
     style="color: #000000;">;</span></div>
  <div><span
     style="color: #0000ff;">const</span><span
     style="color: #000000;"> PERDONAME = </span><span
     style="color: #a31515;">"perdóname"</span><span
     style="color: #000000;">;</span></div>
  <div><span
     style="color: #0000ff;">const</span><span
     style="color: #000000;"> ALIAS = </span><span
     style="color: #a31515;">"alias"</span><span
     style="color: #000000;">;</span></div>
  <div><span
     style="color: #0000ff;">const</span><span
     style="color: #000000;"> ADMINISTRADOR =</span></div>
  <div><span
     style="color: #a31515;">"administrador"</span><span
     style="color: #000000;">;</span></div>
  <div><span
     style="color: #0000ff;">const</span><span
     style="color: #000000;"> MENSAJE = </span><span
     style="color: #a31515;">"mensaje"</span><span
     style="color: #000000;">;</span></div><br>
  <div><span
     style="color: #0000ff;">class</span><span
     style="color: #000000;"> </span><span
     style="color: #267f99;">ChatSerio</span><span
     style="color: #000000;"> </span><span
     style="color: #0000ff;">implements</span></div>
  <div><span
     style="color: #000000;">&nbsp;</span><span
     style="color: #267f99;">MessageComponentInterface</span></div>
  <div><span
     style="color: #000000;">{</span></div>
  <div><span
     style="color: #000000;">&nbsp;</span><span
     style="color: #0000ff;">private</span></div>
  <div><span
     style="color: #000000;">&nbsp;SplObjectStorage </span><span
     style="color: #001080;">$conexiones</span><span
     style="color: #000000;">;</span></div>
  <div><span
     style="color: #000000;">&nbsp;</span><span
     style="color: #0000ff;">private</span><span
     style="color: #000000;"> </span><span
     style="color: #0000ff;">string</span><span
     style="color: #000000;"> </span><span
     style="color: #001080;">$msgCastigado</span><span
     style="color: #000000;">;</span></div><br>
  <div><span
     style="color: #000000;">&nbsp;</span><span
     style="color: #0000ff;">public</span><span
     style="color: #000000;"> </span><span
     style="color: #0000ff;">function</span><span
     style="color: #000000;"> </span><span
     style="color: #795e26;">__construct</span><span
     style="color: #000000;">()</span></div>
  <div><span
     style="color: #000000;">&nbsp;{</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #008000;">// Crea un arreglo de objetos.</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #0000ff;">$this</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #001080;">conexiones</span><span
     style="color: #000000;"> =</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;</span><span
     style="color: #0000ff;">new</span><span
     style="color: #000000;"> </span><span
     style="color: #267f99;">SplObjectStorage</span><span
     style="color: #000000;">;</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #001080;">$info_castigado</span><span
     style="color: #000000;"> = [</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;ALIAS =&gt; ADMINISTRADOR,</span>
  </div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;MENSAJE =&gt; CASTIGADO</span>
  </div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;];</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #0000ff;">$this</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #001080;">msgCastigado</span><span
     style="color: #000000;"> =</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;</span><span
     style="color: #795e26;">json_encode</span><span
     style="color: #000000;">(</span><span
     style="color: #001080;">$info_castigado</span><span
     style="color: #000000;">);</span></div>
  <div><span
     style="color: #000000;">&nbsp;}</span></div><br>
  <div><span
     style="color: #000000;">&nbsp;</span><span
     style="color: #0000ff;">public</span><span
     style="color: #000000;"> </span><span
     style="color: #0000ff;">function</span><span
     style="color: #000000;"> </span><span
     style="color: #795e26;">onOpen</span><span
     style="color: #000000;">(</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #267f99;">ConnectionInterface</span><span
     style="color: #000000;"> </span><span
     style="color: #001080;">$con</span></div>
  <div><span
     style="color: #000000;">&nbsp;)&nbsp;{</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #008000;">// Guarda la conexión.</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #0000ff;">$this</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #001080;">conexiones</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #795e26;">attach</span><span
     style="color: #000000;">(</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;</span><span
     style="color: #001080;">$con</span><span
     style="color: #000000;">,</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;[</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;ID =&gt; </span><span
     style="color: #001080;">$con</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #001080;">resourceId</span><span
     style="color: #000000;">,</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;CASTIGADO =&gt;
   </span><span
     style="color: #0000ff;">false</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;]</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;);</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #795e26;">echo</span><span
     style="color: #000000;"> </span><span
     style="color: #a31515;">"Conectado: "</span><span
     style="color: #000000;"> </span><span
     style="color: #000000;">.</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;</span><span
     style="color: #001080;">$con</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #001080;">resourceId</span><span
     style="color: #000000;"> </span><span
     style="color: #000000;">.</span><span
     style="color: #000000;"> </span><span
     style="color: #a31515;">"</span><span
     style="color: #ee0000;">\n</span><span
     style="color: #a31515;">"</span><span
     style="color: #000000;">;</span></div>
  <div><span
     style="color: #000000;">&nbsp;}</span></div><br>
  <div><span
     style="color: #000000;">&nbsp;</span><span
     style="color: #0000ff;">public</span><span
     style="color: #000000;"> </span><span
     style="color: #0000ff;">function</span><span
     style="color: #000000;"> </span><span
     style="color: #795e26;">onMessage</span><span
     style="color: #000000;">(</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #267f99;">ConnectionInterface</span><span
     style="color: #000000;"> </span><span
     style="color: #001080;">$origen</span><span
     style="color: #000000;">,</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #001080;">$msg</span></div>
  <div><span
     style="color: #000000;">&nbsp;)&nbsp;{</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #001080;">$conexiones</span><span
     style="color: #000000;"> = </span><span
     style="color: #0000ff;">$this</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #001080;">conexiones</span><span
     style="color: #000000;">;</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #001080;">$info</span><span
     style="color: #000000;"> = </span><span
     style="color: #001080;">$conexiones</span><span
     style="color: #000000;">[</span><span
     style="color: #001080;">$origen</span><span
     style="color: #000000;">];</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #001080;">$id</span><span
     style="color: #000000;"> = </span><span
     style="color: #001080;">$info</span><span
     style="color: #000000;">[ID];</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #001080;">$castigado</span><span
     style="color: #000000;"> = </span><span
     style="color: #001080;">$info</span><span
     style="color: #000000;">[CASTIGADO];</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #001080;">$json</span><span
     style="color: #000000;"> = </span><span
     style="color: #795e26;">json_decode</span><span
     style="color: #000000;">(</span><span
     style="color: #001080;">$msg</span><span
     style="color: #000000;">);</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #001080;">$alias</span><span
     style="color: #000000;"> = </span><span
     style="color: #001080;">$json</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #001080;">alias</span><span
     style="color: #000000;">;</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #001080;">$mensaje</span><span
     style="color: #000000;"> = </span><span
     style="color: #001080;">$json</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #001080;">mensaje</span><span
     style="color: #000000;">;</span></div><br>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #af00db;">if</span><span
     style="color: #000000;"> (</span><span
     style="color: #001080;">$castigado</span><span
     style="color: #000000;">)&nbsp;{</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;</span><span
     style="color: #af00db;">if</span><span
     style="color: #000000;"> (</span><span
     style="color: #001080;">$mensaje</span><span
     style="color: #000000;"> === PERDONAME)&nbsp;{</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span
     style="color: #001080;">$castigado</span><span
     style="color: #000000;"> = </span><span
     style="color: #0000ff;">false</span><span
     style="color: #000000;">;</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;}&nbsp;</span><span
     style="color: #af00db;">else</span><span
     style="color: #000000;">&nbsp;{</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span
     style="color: #001080;">$origen</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #795e26;">send</span><span
     style="color: #000000;">(</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span
     style="color: #0000ff;">$this</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #001080;">msgCastigado</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;);</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;}</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;}&nbsp;</span><span
     style="color: #af00db;">elseif</span><span
     style="color: #000000;"> (</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;</span><span
     style="color: #795e26;">preg_match</span><span
     style="color: #000000;">(</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span
     style="color: #811f3f;">"/(</span><span
     style="color: #000000;">^</span><span
     style="color: #811f3f;">|\s</span><span
     style="color: #000000;">+</span><span
     style="color: #811f3f;">)wey(</span><span
     style="color: #000000;">$</span><span
     style="color: #811f3f;">|\s</span><span
     style="color: #000000;">+</span><span
     style="color: #811f3f;">)/i"</span><span
     style="color: #000000;">,</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span
     style="color: #001080;">$mensaje</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;)</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;!== </span><span
     style="color: #098658;">0</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;)&nbsp;{</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;</span><span
     style="color: #001080;">$castigado</span><span
     style="color: #000000;"> = </span><span
     style="color: #0000ff;">true</span><span
     style="color: #000000;">;</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;</span><span
     style="color: #001080;">$origen</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #795e26;">send</span><span
     style="color: #000000;">(</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span
     style="color: #0000ff;">$this</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #001080;">msgCastigado</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;);</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;}</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #001080;">$info</span><span
     style="color: #000000;">[CASTIGADO] = </span><span
     style="color: #001080;">$castigado</span><span
     style="color: #000000;">;</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #001080;">$conexiones</span><span
     style="color: #000000;">[</span><span
     style="color: #001080;">$origen</span><span
     style="color: #000000;">] = </span><span
     style="color: #001080;">$info</span><span
     style="color: #000000;">;</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #795e26;">echo</span><span
     style="color: #000000;"> </span><span
     style="color: #a31515;">"</span></div>
  <div><span
     style="color: #a31515;">Origen:&nbsp;{</span><span
     style="color: #001080;">$id</span><span
     style="color: #a31515;">}</span></div>
  <div><span
     style="color: #a31515;">Castigado:&nbsp;{</span><span
     style="color: #001080;">$castigado</span><span
     style="color: #a31515;">}</span></div>
  <div><span
     style="color: #a31515;">alias:&nbsp;{</span><span
     style="color: #001080;">$alias</span><span
     style="color: #a31515;">}</span></div>
  <div><span
     style="color: #a31515;">Mensaje:&nbsp;{</span><span
     style="color: #001080;">$mensaje</span><span
     style="color: #a31515;">}</span></div>
  <div><span
     style="color: #a31515;">"</span><span
     style="color: #000000;">;</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #001080;">$conexiones</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #795e26;">rewind</span><span
     style="color: #000000;">();</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #af00db;">while</span><span
     style="color: #000000;"> (</span><span
     style="color: #001080;">$conexiones</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #795e26;">valid</span><span
     style="color: #000000;">())&nbsp;{</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;</span><span
     style="color: #001080;">$con</span><span
     style="color: #000000;"> = </span><span
     style="color: #001080;">$conexiones</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #795e26;">current</span><span
     style="color: #000000;">();</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;</span><span
     style="color: #001080;">$info</span><span
     style="color: #000000;"> = </span><span
     style="color: #001080;">$conexiones</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #795e26;">getInfo</span><span
     style="color: #000000;">();</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;</span><span
     style="color: #795e26;">var_dump</span><span
     style="color: #000000;">(</span><span
     style="color: #001080;">$info</span><span
     style="color: #000000;">);</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;</span><span
     style="color: #af00db;">if</span><span
     style="color: #000000;"> (!</span><span
     style="color: #001080;">$info</span><span
     style="color: #000000;">[CASTIGADO])&nbsp;{</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span
     style="color: #001080;">$con</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #795e26;">send</span><span
     style="color: #000000;">(</span><span
     style="color: #001080;">$msg</span><span
     style="color: #000000;">);</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;}</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;</span><span
     style="color: #001080;">$conexiones</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #795e26;">next</span><span
     style="color: #000000;">();</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;}</span></div>
  <div><span
     style="color: #000000;">&nbsp;}</span></div><br>
  <div><span
     style="color: #000000;">&nbsp;</span><span
     style="color: #0000ff;">public</span><span
     style="color: #000000;"> </span><span
     style="color: #0000ff;">function</span><span
     style="color: #000000;"> </span><span
     style="color: #795e26;">onClose</span><span
     style="color: #000000;">(</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #267f99;">ConnectionInterface</span><span
     style="color: #000000;"> </span><span
     style="color: #001080;">$con</span></div>
  <div><span
     style="color: #000000;">&nbsp;)&nbsp;{</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #0000ff;">$this</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #001080;">conexiones</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #795e26;">detach</span><span
     style="color: #000000;">(</span><span
     style="color: #001080;">$con</span><span
     style="color: #000000;">);</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #795e26;">echo</span><span
     style="color: #000000;"> </span><span
     style="color: #a31515;">"Desconectado: "</span><span
     style="color: #000000;"> </span><span
     style="color: #000000;">.</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;</span><span
     style="color: #001080;">$con</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #001080;">resourceId</span><span
     style="color: #000000;"> </span><span
     style="color: #000000;">.</span><span
     style="color: #000000;"> </span><span
     style="color: #a31515;">"</span><span
     style="color: #ee0000;">\n</span><span
     style="color: #a31515;">"</span><span
     style="color: #000000;">;</span></div>
  <div><span
     style="color: #000000;">&nbsp;}</span></div><br>
  <div><span
     style="color: #000000;">&nbsp;</span><span
     style="color: #0000ff;">public</span><span
     style="color: #000000;"> </span><span
     style="color: #0000ff;">function</span><span
     style="color: #000000;"> </span><span
     style="color: #795e26;">onError</span><span
     style="color: #000000;">(</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #267f99;">ConnectionInterface</span><span
     style="color: #000000;"> </span><span
     style="color: #001080;">$con</span><span
     style="color: #000000;">,</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #267f99;">\Exception</span><span
     style="color: #000000;"> </span><span
     style="color: #001080;">$e</span></div>
  <div><span
     style="color: #000000;">&nbsp;)&nbsp;{</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #795e26;">echo</span><span
     style="color: #000000;"> </span><span
     style="color: #a31515;">"Error: "</span><span
     style="color: #000000;"> </span><span
     style="color: #000000;">.</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;&nbsp;</span><span
     style="color: #001080;">$e</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #795e26;">getMessage</span><span
     style="color: #000000;">() </span><span
     style="color: #000000;">.</span><span
     style="color: #000000;"> </span><span
     style="color: #a31515;">"</span><span
     style="color: #ee0000;">\n</span><span
     style="color: #a31515;">"</span><span
     style="color: #000000;">;</span></div>
  <div><span
     style="color: #000000;">&nbsp;&nbsp;</span><span
     style="color: #001080;">$con</span><span
     style="color: #000000;">-&gt;</span><span
     style="color: #795e26;">close</span><span
     style="color: #000000;">();</span></div>
  <div><span
     style="color: #000000;">&nbsp;}</span></div>
  <div><span
     style="color: #000000;">}</span></div><br>
 </div>
</muestra-codigo>